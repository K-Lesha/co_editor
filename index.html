<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Slides Manager</title>
<style>
  :root{--bg:#0b0b0d;--card:#141418;--text:#eaeaf0;--muted:#9aa0a6;--accent:#6ea8fe}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .wrap{max-width:1000px;margin:0 auto;padding:24px}
  h1{margin:0 0 6px}
  .muted{color:var(--muted)}
  .projects{display:grid;gap:10px;margin-top:14px}
  .row{display:flex;justify-content:space-between;align-items:center;background:#141418;border:1px solid #24252d;border-radius:12px;padding:12px 14px;cursor:pointer}
  .row:hover{border-color:#2f3240}
  .pid{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70vw}
  .count{color:var(--muted);font-size:14px}
  .loading,.error{margin-top:14px;padding:16px;border:1px dashed #2a2b33;border-radius:12px}

  /* overlay sheet */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none}
  .overlay.show{display:block}
  .sheet{position:absolute;inset:4% 4% 4% 4%;background:#0f1014;border-radius:16px;overflow:hidden;border:1px solid #2a2b33;display:flex;flex-direction:column}
  .hdr{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid #252635;background:#12131a}
  .hdrL{display:flex;flex-direction:column;gap:4px}
  .hdr .pid{max-width:60vw}
  .actions{display:flex;gap:8px;align-items:center}
  button{background:#1b1c22;border:1px solid #2a2b33;color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
  .primary{background:var(--accent);border-color:var(--accent);color:#0b0b0d;font-weight:700}
  .danger{border-color:#7b2e2e;background:#2a1414}
  .body{flex:1;overflow:auto;padding:14px}
  .slides{display:grid;gap:10px}
  .slide{background:#141418;border:1px solid #24252d;border-radius:12px;padding:12px;display:grid;grid-template-columns:36px 180px 1fr 260px auto;gap:10px;align-items:start}
  .drag{cursor:grab;user-select:none;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  .drag:active{cursor:grabbing}
  .num{color:var(--muted);font-size:12px}
  .typeIn,.templSel{width:100%;padding:8px;border-radius:8px;border:1px solid #2a2b33;background:#101117;color:var(--text)}
  .textIn{width:100%;min-height:100px;resize:vertical;padding:10px;border-radius:10px;border:1px solid #2a2b33;background:#101117;color:var(--text);white-space:pre-wrap}
  .previewCard{background:#101117;border:1px solid #2a2b33;border-radius:10px;padding:10px;overflow:auto;max-height:160px}
  .previewTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;color:var(--muted);font-size:12px}
  .delBtn{align-self:center}
  .footer{padding:10px 14px;border-top:1px solid #252635;background:#12131a;display:flex;justify-content:space-between;align-items:center}
  .hint{color:var(--muted);font-size:13px}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #2a2b33;background:#1b1c22}

  /* лёгкие базовые стили для мок-шаблонов */
  .block{font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
  .block h2{margin:0 0 6px;font-size:18px}
  .block p{margin:0 0 6px}
  .block ul{margin:6px 0 0 18px;padding:0}
  .two-cols .cols,.three-cols .cols{display:grid;gap:8px}
  .two-cols .cols{grid-template-columns:1fr 1fr}
  .three-cols .cols{grid-template-columns:1fr 1fr 1fr}
  .center-text{display:flex;align-items:center;justify-content:center;min-height:80px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Все слайды</h1>
    <div class="muted">Клик по проекту — откроется редактор. Перетаскивай слайды за «≡». Выбирай шаблон, редактируй текст, сохраняй.</div>
    <div id="loading" class="loading">Загрузка…</div>
    <div id="error" class="error" style="display:none"></div>
    <div id="projects" class="projects"></div>
  </div>

  <!-- Overlay Editor -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="hdr">
        <div class="hdrL">
          <div class="muted">Редактор проекта</div>
          <div id="ovPid" class="pid"></div>
        </div>
        <div class="actions">
          <button id="addBtn">+ Слайд</button>
          <button id="saveBtn" class="primary">Сохранить всё</button>
          <button id="closeBtn">Закрыть</button>
        </div>
      </div>
      <div class="body">
        <div id="ovSlides" class="slides"></div>
      </div>
      <div class="footer">
        <div class="hint">POST → <span class="pill">/webhook/slides-sync</span> c полями <span class="pill">template_id</span> в каждом слайде</div>
        <div id="status" class="muted"></div>
      </div>
    </div>
  </div>

<script>
  // === CONFIG ===
  const ENDPOINT_LIST      = "https://kvlnk247-n8n.duckdns.org/webhook/slides-items";       // чтение слайдов
  const ENDPOINT_TEMPLATES = "https://kvlnk247-n8n.duckdns.org/webhook/slides-templates";   // чтение шаблонов
  const ENDPOINT_SAVE      = "https://kvlnk247-n8n.duckdns.org/webhook/slides-sync";   // запись (replace)

  // === State ===
  let allItems = [];                 // сырые слайды
  let grouped = new Map();           // project_id -> items[]
  let currentProjectId = null;       // открытый проект
  let templates = [];                // список шаблонов
  let templatesById = new Map();     // id -> template

  // DOM
  const elProjects = document.getElementById("projects");
  const elLoading  = document.getElementById("loading");
  const elError    = document.getElementById("error");
  const overlay    = document.getElementById("overlay");
  const ovPidEl    = document.getElementById("ovPid");
  const ovSlidesEl = document.getElementById("ovSlides");
  const closeBtn   = document.getElementById("closeBtn");
  const addBtn     = document.getElementById("addBtn");
  const saveBtn    = document.getElementById("saveBtn");
  const statusEl   = document.getElementById("status");

  const bySlide = (a,b)=> (Number(a.slide)||0) - (Number(b.slide)||0);
  const qs = new URLSearchParams(location.search);

  init();

  async function init(){
    await Promise.all([fetchAllSlides(), fetchTemplates()]);
    renderProjects();

    const deep = qs.get("project_id");
    if (deep && grouped.has(deep)) openEditor(deep);

    overlay.addEventListener("click", e => { if (e.target === overlay) closeEditor(); });
    closeBtn.addEventListener("click", closeEditor);
    window.addEventListener("keydown", e => { if (e.key === "Escape") closeEditor(); });
    window.addEventListener("popstate", () => {
      const pid = new URLSearchParams(location.search).get("project_id");
      if (pid && grouped.has(pid)) openEditor(pid, {push:false});
      else closeEditor({push:false});
    });

    addBtn.addEventListener("click", () => addSlideUI());
    saveBtn.addEventListener("click", saveAll);
  }

  async function fetchAllSlides(){
    try{
      const res = await fetch(ENDPOINT_LIST);
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const data = await res.json();
      allItems = Array.isArray(data) ? data : (data.data || data.items || []);
      grouped = new Map();
      for(const it of allItems){
        const pid = it.project_id || "—";
        if(!grouped.has(pid)) grouped.set(pid, []);
        grouped.get(pid).push({...it});
      }
      for(const arr of grouped.values()) arr.sort(bySlide);
      elLoading.style.display = "none";
    }catch(e){
      elLoading.style.display = "none";
      elError.style.display = "block";
      elError.textContent = "Ошибка загрузки: " + e.message;
    }
  }

  async function fetchTemplates(){
    try{
      const res = await fetch(ENDPOINT_TEMPLATES, { method: "POST", headers: { "Content-Type": "application/json" } });
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const data = await res.json();
      templates = Array.isArray(data) ? data : (data.data || data.items || []);
      templatesById = new Map(templates.map(t => [String(t.id), t]));
    }catch(e){
      console.warn("Не удалось загрузить шаблоны:", e);
      templates = [];
      templatesById = new Map();
    }
  }

  function renderProjects(){
    elProjects.innerHTML = "";
    const entries = Array.from(grouped.entries()).sort((a,b)=> String(a[0]).localeCompare(String(b[0])));
    for(const [pid, items] of entries){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div>
          <div class="muted">project_id</div>
          <div class="pid" title="${escapeHtml(pid)}">${escapeHtml(pid)}</div>
        </div>
        <div class="count">${items.length} слайдов</div>
      `;
      row.addEventListener("click", () => openEditor(pid));
      elProjects.appendChild(row);
    }
  }

  function openEditor(projectId, {push=true}={}){
    currentProjectId = projectId;
    ovPidEl.textContent = projectId;
    statusEl.textContent = "";
    renderSlidesEditor();
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
    if(push){
      const p = new URLSearchParams(location.search);
      p.set("project_id", projectId);
      history.pushState({}, "", location.pathname + "?" + p.toString());
    }
  }

  function closeEditor({push=true}={}){
    if(!overlay.classList.contains("show")) return;
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
    currentProjectId = null;
    if(push){
      const p = new URLSearchParams(location.search);
      p.delete("project_id");
      history.pushState({}, "", location.pathname + (p.toString()?("?"+p.toString()):""));
    }
  }

  function renderSlidesEditor(){
    ovSlidesEl.innerHTML = "";
    const slides = (grouped.get(currentProjectId) || []).map(s => ({...s}));
    slides.sort(bySlide).forEach((s,i)=> s.slide = i+1);
    slides.forEach((s) => ovSlidesEl.appendChild(makeSlideRow(s)));
    ovSlidesEl.querySelectorAll(".slide").forEach(initDrag);
  }

  function makeSlideRow(slide){
  const row = document.createElement("div");
  row.className = "slide";
  row.setAttribute("draggable","true");

  // нормализуем и сохраняем выбранный шаблон
  row.dataset.templateId = slide.template_id ? String(slide.template_id) : "";

  const selectHtml = `<select class="templSel">
    <option value="">— выбрать шаблон —</option>
    ${templates.map(t => `
      <option value="${escapeAttr(String(t.id))}"${
        String(t.id) === String(slide.template_id) ? ' selected' : ''
      }>${escapeHtml(t.name || String(t.id))}</option>
    `).join("")}
  </select>`;

  row.innerHTML = `
    <div class="drag" title="Перетащить" aria-label="drag">≡</div>
    <div>
      <div class="num">Слайд</div>
      <div class="num"><span class="numVal">${slide.slide}</span></div>
      <div class="num" style="margin-top:8px">Тип</div>
      <input class="typeIn" value="${escapeAttr(slide.type ?? '')}" placeholder="type (cover, context, ...)" />
      <div class="num" style="margin-top:8px">Шаблон</div>
      ${selectHtml}
    </div>
    <div>
      <div class="num">Текст</div>
      <textarea class="textIn" placeholder="текст слайда...">${escapeHtml(slide.text ?? "")}</textarea>
    </div>
    <div>
      <div class="previewTitle"><span>Предпросмотр</span><span class="muted small"></span></div>
      <div class="previewCard"><div class="previewInner"></div></div>
    </div>
    <div class="delBtn">
      <button class="danger">Удалить</button>
    </div>
  `;

  row.querySelector(".danger").addEventListener("click", () => { row.remove(); renumberUI(); });
  const templSel = row.querySelector(".templSel");
  templSel.addEventListener("change", () => {
    row.dataset.templateId = templSel.value || "";
    renderPreview(row);
  });

  renderPreview(row);
  return row;
}

  function renderPreview(row){
    const tplId = row.dataset.templateId || "";
    const holder = row.querySelector(".previewInner");
    holder.innerHTML = "";
    if(!tplId || !templatesById.has(tplId)){
      holder.innerHTML = `<div class="muted">Шаблон не выбран</div>`;
      return;
    }
    const tpl = templatesById.get(tplId);
    // берём html_mock и подставляем мок‑текст
    const mockMap = {
      "{{headline}}":"Заголовок",
      "{{text}}":"Короткий абзац текста. Два-три предложения для примера.",
      "{{col1}}":"Колонка 1 — мок‑текст",
      "{{col2}}":"Колонка 2 — мок‑текст",
      "{{col3}}":"Колонка 3 — мок‑текст",
      "{{bullet1}}":"Пункт 1",
      "{{bullet2}}":"Пункт 2",
      "{{bullet3}}":"Пункт 3",
      "{{quote}}":"«Вдохновляющая цитата»",
      "{{author}}":"Имя Автора"
    };
    let html = String(tpl.html_mock || "").trim();
    for(const [k,v] of Object.entries(mockMap)){
      html = html.split(k).join(v);
    }
    // безопасно вставляем как innerHTML маленький мок-блок
    try{
      holder.innerHTML = html;
    }catch(_){
      holder.textContent = "Ошибка в html_mock";
    }
  }

  function initDrag(el){
    el.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", "");
      el.classList.add("dragging");
    });
    el.addEventListener("dragend", () => {
      el.classList.remove("dragging");
      renumberUI();
    });
    ovSlidesEl.addEventListener("dragover", e => {
      e.preventDefault();
      const dragging = ovSlidesEl.querySelector(".dragging");
      const after = getDragAfterElement(ovSlidesEl, e.clientY);
      if (!after) ovSlidesEl.appendChild(dragging);
      else ovSlidesEl.insertBefore(dragging, after);
    });
  }

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll(".slide:not(.dragging)")];
    return els.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if (offset < 0 && offset > closest.offset) return { offset, element: child };
      return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function renumberUI(){
    [...ovSlidesEl.querySelectorAll(".slide")].forEach((row, i) => {
      row.querySelector(".numVal").textContent = i+1;
    });
  }

  function addSlideUI(){
    const row = makeSlideRow({ slide: (ovSlidesEl.children.length+1), type:"", text:"", template_id: "" });
    ovSlidesEl.appendChild(row);
    initDrag(row);
    renumberUI();
    row.querySelector(".textIn").focus();
  }

  function buildSlidesPayload(){
    const rows = [...ovSlidesEl.querySelectorAll(".slide")];
    return rows.map((row, i) => {
      const type = row.querySelector(".typeIn").value.trim();
      const text = row.querySelector(".textIn").value;
      const template_id = row.dataset.templateId || null;
      return { slide: i+1, type, text, template_id };
    });
  }

  async function saveAll(){
    const slides = buildSlidesPayload();
    if(!currentProjectId){ return; }
    statusEl.textContent = "Сохранение…";

    try{
      const res = await fetch(ENDPOINT_SAVE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          project_id: currentProjectId,
          replace: true,
          slides
        })
      });
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      await res.json().catch(()=> ({}));
      statusEl.textContent = "Готово ✔";
      // локально обновим
      grouped.set(currentProjectId, slides.map(s => ({...s, project_id: currentProjectId})));
      renderProjects();
    }catch(e){
      statusEl.textContent = "Ошибка: " + e.message;
    }
  }

  // === utils ===
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }
  function escapeAttr(s){
    return String(s ?? "").replaceAll('"',"&quot;");
  }
</script>
</body>
</html>
