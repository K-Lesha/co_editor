<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Slides Manager</title>
<style>
  :root{--bg:#0b0b0d;--card:#141418;--text:#eaeaf0;--muted:#9aa0a6;--accent:#6ea8fe}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .wrap{max-width:1000px;margin:0 auto;padding:24px}
  h1{margin:0 0 6px}
  .muted{color:var(--muted)}
  .projects{display:grid;gap:10px;margin-top:14px}
  .row{display:flex;justify-content:space-between;align-items:center;background:#141418;border:1px solid #24252d;border-radius:12px;padding:12px 14px;cursor:pointer}
  .row:hover{border-color:#2f3240}
  .pid{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70vw}
  .count{color:var(--muted);font-size:14px}
  .loading,.error{margin-top:14px;padding:16px;border:1px dashed #2a2b33;border-radius:12px}

  /* overlay sheet */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none}
  .overlay.show{display:block}
  .sheet{position:absolute;inset:4% 4% 4% 4%;background:#0f1014;border-radius:16px;overflow:hidden;border:1px solid #2a2b33;display:flex;flex-direction:column}
  .hdr{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid #252635;background:#12131a}
  .hdrL{display:flex;flex-direction:column;gap:4px}
  .hdr .pid{max-width:60vw}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{background:#1b1c22;border:1px solid #2a2b33;color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
  .primary{background:var(--accent);border-color:var(--accent);color:#0b0b0d;font-weight:700}
  .danger{border-color:#7b2e2e;background:#2a1414}
  .body{flex:1;overflow:auto;padding:14px}
  .slides{display:grid;gap:10px}
  .slide{background:#141418;border:1px solid #24252d;border-radius:12px;padding:12px;display:grid;grid-template-columns:36px 180px 1fr 260px auto;gap:10px;align-items:start}
  .drag{cursor:grab;user-select:none;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  .drag:active{cursor:grabbing}
  .num{color:var(--muted);font-size:12px}
  .typeIn,.templSel{width:100%;padding:8px;border-radius:8px;border:1px solid #2a2b33;background:#101117;color:var(--text)}
  .textIn{width:100%;min-height:100px;resize:vertical;padding:10px;border-radius:10px;border:1px solid #2a2b33;background:#101117;color:var(--text);white-space:pre-wrap}
  .previewCard {
    background: #fff;
    border: 1px solid #ccc;border-radius: 10px;padding: 10px;overflow: auto;max-height: 160px;
    color: #000;font-size: 13px;line-height: 1.4;
  }
  .previewCard .block {font-size:13px;line-height:1.4;color:#000;}
  .previewCard h2 {font-size:15px;margin:0 0 6px;}
  .delBtn{align-self:center}
  .footer{padding:10px 14px;border-top:1px solid #252635;background:#12131a;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .hint{color:var(--muted);font-size:13px}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #2a2b33;background:#1b1c22}

  /* –º–æ–∫-—à–∞–±–ª–æ–Ω—ã */
  .block{font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .block h2{margin:0 0 6px;font-size:18px}
  .block p{margin:0 0 6px}
  .block ul{margin:6px 0 0 18px;padding:0}
  .two-cols .cols,.three-cols .cols{display:grid;gap:8px}
  .two-cols .cols{grid-template-columns:1fr 1fr}
  .three-cols .cols{grid-template-columns:1fr 1fr 1fr}
  .center-text{display:flex;align-items:center;justify-content:center;min-height:80px;text-align:center}
  a.link{color:#9ec2ff;text-decoration:none;border-bottom:1px dashed #3a5ea8}
  a.link:hover{border-bottom-style:solid}

  /* NEW PROJECT MODAL STYLES */
.new-project-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:1001}
.new-project-overlay.show{display:block}
.new-project-sheet{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:600px;max-height:90vh;background:#0f1014;border-radius:16px;border:1px solid #2a2b33;display:flex;flex-direction:column;overflow:hidden}
.new-project-body{flex:1;overflow:auto;padding:20px}
.form-group{margin-bottom:16px}
.form-label{display:block;margin-bottom:6px;color:var(--text);font-weight:500;font-size:14px}
.form-input,.form-textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #2a2b33;background:#101117;color:var(--text);font-size:14px}
.form-textarea{min-height:80px;resize:vertical;font-family:inherit}
.form-input:focus,.form-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(110,168,254,0.1)}
.file-upload-area{border:2px dashed #2a2b33;border-radius:8px;padding:20px;text-align:center;background:#0f1014;cursor:pointer;transition:all 0.3s ease}
.file-upload-area:hover,.file-upload-area.dragover{border-color:var(--accent);background:#141620}
.file-upload-area input[type="file"]{display:none}
.file-list{margin-top:8px}
.file-item{display:flex;align-items:center;justify-content:space-between;padding:8px;background:#1b1c22;border:1px solid #2a2b33;border-radius:6px;margin-bottom:4px}
.file-info{display:flex;align-items:center;gap:8px}
.file-name{font-size:13px;color:var(--text)}
.file-size{font-size:12px;color:var(--muted)}
.file-remove{background:none;border:none;color:var(--muted);cursor:pointer;padding:4px;border-radius:4px}
.file-remove:hover{color:#ff6b6b;background:#2a1414}
.submit-section{margin-top:20px;padding-top:16px;border-top:1px solid #252635}
.progress-bar{width:100%;height:4px;background:#2a2b33;border-radius:2px;overflow:hidden;margin:8px 0}
.progress-fill{height:100%;background:var(--accent);width:0%;transition:width 0.3s ease}
.status-message{padding:8px 12px;border-radius:6px;margin-top:8px;font-size:14px}
.status-success{background:rgba(40,167,69,0.1);border:1px solid rgba(40,167,69,0.3);color:var(--success)}
.status-error{background:rgba(220,53,69,0.1);border:1px solid rgba(220,53,69,0.3);color:#ff6b6b}
.status-info{background:rgba(110,168,254,0.1);border:1px solid rgba(110,168,254,0.3);color:var(--accent)}

</style>
</head>
<body>
  <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:6px">
  <h1 style="margin:0">–í—Å–µ —Å–ª–∞–π–¥—ã</h1>
  <button id="newProjectBtn" class="primary">+ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
</div>

  <!-- Overlay Editor -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="hdr">
        <div class="hdrL">
          <div class="muted">–†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞</div>
          <div id="ovPid" class="pid"></div>
        </div>
        <div class="actions">
          <button id="addBtn">+ –°–ª–∞–π–¥</button>
          <button id="saveBtn" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
          <!-- NEW: Publish -->
          <button id="publishBtn" class="primary" title="–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" style="display:none">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <button id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
      <div class="body">
        <div id="ovSlides" class="slides"></div>
      </div>
      <div class="footer">
        <div class="hint">POST ‚Üí <span class="pill">/webhook/slides-sync</span> c –ø–æ–ª—è–º–∏ <span class="pill">template_id</span> –≤ –∫–∞–∂–¥–æ–º —Å–ª–∞–π–¥–µ</div>
        <div id="status" class="muted"></div>
      </div>
    </div>
  </div>



    <!-- New project overlay -->

<div id="newProjectOverlay" class="new-project-overlay" aria-hidden="true">
  <div class="new-project-sheet" role="dialog" aria-modal="true">
    <div class="hdr">
      <div class="hdrL">
        <div class="muted">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞</div>
        <div style="font-size:14px;color:var(--muted)">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü</div>
      </div>
      <div class="actions">
        <button id="closeNewProjectBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    
    <div class="new-project-body">
      <form id="newProjectForm">
        <div class="form-group">
          <label class="form-label" for="clientName">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
          <input type="text" id="clientName" name="clientName" class="form-input" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞">
        </div>

        <div class="form-group">
          <label class="form-label" for="currentContext">–¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–≤–≤–æ–¥–Ω–∞—è / –±—Ä–∏—Ñ)</label>
          <textarea id="currentContext" name="currentContext" class="form-textarea" required placeholder="–ö–∞–∫ –º—ã –ø–æ–Ω—è–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label" for="taskDecomposition">–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –∑–∞–¥–∞—á</label>
          <textarea id="taskDecomposition" name="taskDecomposition" class="form-textarea" required placeholder="–ö–∞—Å–∫–∞–¥ - –∑–∞–¥–∞—á–∏ –±–∏–∑–Ω–µ—Å–∞ / –∑–∞–¥–∞—á–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ / –∑–∞–¥–∞—á–∏ –ø—Ä–æ–µ–∫—Ç–∞"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (PDF)</label>
          <div class="file-upload-area" id="coUploadArea">
            <input type="file" id="commercialOffer" name="commercial_offer_all_sheets_pdf" accept=".pdf">
            <div>üìÑ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ PDF —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
            <div class="muted" style="font-size:12px;margin-top:4px">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ PDF —Ñ–æ—Ä–º–∞—Ç</div>
          </div>
          <div id="coFileList" class="file-list"></div>
        </div>

        <div class="form-group">
          <label class="form-label">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ (–±—Ä–∏—Ñ—ã, —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã)</label>
          <div class="file-upload-area" id="agencyUploadArea">
            <input type="file" id="agencyFiles" name="agency_files" multiple>
            <div>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
            <div class="muted" style="font-size:12px;margin-top:4px">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤</div>
          </div>
          <div id="agencyFileList" class="file-list"></div>
        </div>

        <div class="form-group">
          <label class="form-label">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫–ª–∏–µ–Ω—Ç–∞ (–≥–∞–π–¥—ã, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏)</label>
          <div class="file-upload-area" id="clientUploadArea">
            <input type="file" id="clientFiles" name="client_files" multiple>
            <div>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
            <div class="muted" style="font-size:12px;margin-top:4px">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤</div>
          </div>
          <div id="clientFileList" class="file-list"></div>
        </div>

        <div class="submit-section">
          <button type="submit" id="submitBtn" class="primary" style="width:100%;padding:14px;font-size:16px">
            üöÄ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
          </button>
          <div id="progress" class="progress-bar" style="display:none">
            <div id="progressFill" class="progress-fill"></div>
          </div>
          <div id="formStatus"></div>
        </div>
      </form>
    </div>
  </div>
</div>
  
  
<script>
  // === CONFIG ===
  const ENDPOINT_LIST      = "https://kvlnk247-n8n.duckdns.org/webhook/slides-items";       // —á—Ç–µ–Ω–∏–µ —Å–ª–∞–π–¥–æ–≤
  const ENDPOINT_TEMPLATES = "https://kvlnk247-n8n.duckdns.org/webhook/slides-templates";   // —á—Ç–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤
  const ENDPOINT_SAVE      = "https://kvlnk247-n8n.duckdns.org/webhook/slides-sync";        // –∑–∞–ø–∏—Å—å (replace)
  const ENDPOINT_PUBLISH   = "https://kvlnk247-n8n.duckdns.org/webhook/publish-project";    // –ø—É–±–ª–∏–∫–∞—Ü–∏—è

  // === State ===
  let allItems = [];                 // —Å—ã—Ä—ã–µ —Å–ª–∞–π–¥—ã
  let grouped = new Map();           // project_id -> items[]
  let currentProjectId = null;       // –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–µ–∫—Ç
  let templates = [];                // —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤
  let templatesById = new Map();     // id -> template
  let isDirty = false;               // –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è?

  // DOM
  const elProjects = document.getElementById("projects");
  const elLoading  = document.getElementById("loading");
  const elError    = document.getElementById("error");
  const overlay    = document.getElementById("overlay");
  const ovPidEl    = document.getElementById("ovPid");
  const ovSlidesEl = document.getElementById("ovSlides");
  const closeBtn   = document.getElementById("closeBtn");
  const addBtn     = document.getElementById("addBtn");
  const saveBtn    = document.getElementById("saveBtn");
  const publishBtn = document.getElementById("publishBtn");
  const statusEl   = document.getElementById("status");

  const bySlide = (a,b)=> (Number(a.slide)||0) - (Number(b.slide)||0);
  const qs = new URLSearchParams(location.search);

  init();

  async function init(){
    await Promise.all([fetchAllSlides(), fetchTemplates()]);
    renderProjects();

    const deep = qs.get("project_id");
    if (deep && grouped.has(deep)) openEditor(deep);

    overlay.addEventListener("click", e => { if (e.target === overlay) closeEditor(); });
    closeBtn.addEventListener("click", closeEditor);
    window.addEventListener("keydown", e => { if (e.key === "Escape") closeEditor(); });
    window.addEventListener("popstate", () => {
      const pid = new URLSearchParams(location.search).get("project_id");
      if (pid && grouped.has(pid)) openEditor(pid, {push:false});
      else closeEditor({push:false});
    });

    addBtn.addEventListener("click", () => { addSlideUI(); setDirty(true); });
    saveBtn.addEventListener("click", saveAll);
    publishBtn.addEventListener("click", publishProject);
  }

  async function fetchAllSlides(){
    try{
      const res = await fetch(ENDPOINT_LIST);
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const data = await res.json();
      allItems = Array.isArray(data) ? data : (data.data || data.items || []);
      grouped = new Map();
      for(const it of allItems){
        const pid = it.project_id || "‚Äî";
        if(!grouped.has(pid)) grouped.set(pid, []);
        grouped.get(pid).push({...it});
      }
      for(const arr of grouped.values()) arr.sort(bySlide);
      elLoading.style.display = "none";
    }catch(e){
      elLoading.style.display = "none";
      elError.style.display = "block";
      elError.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + e.message;
    }
  }

  async function fetchTemplates(){
    try{
      const res = await fetch(ENDPOINT_TEMPLATES, { method: "POST", headers: { "Content-Type": "application/json" } });
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const data = await res.json();
      templates = Array.isArray(data) ? data : (data.data || data.items || []);
      templatesById = new Map(templates.map(t => [String(t.id), t]));
    }catch(e){
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω—ã:", e);
      templates = [];
      templatesById = new Map();
    }
  }

  function renderProjects(){
    elProjects.innerHTML = "";
    const entries = Array.from(grouped.entries()).sort((a,b)=> String(a[0]).localeCompare(String(b[0])));
    for(const [pid, items] of entries){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div>
          <div class="muted">project_id</div>
          <div class="pid" title="${escapeHtml(pid)}">${escapeHtml(pid)}</div>
        </div>
        <div class="count">${items.length} —Å–ª–∞–π–¥–æ–≤</div>
      `;
      row.addEventListener("click", () => openEditor(pid));
      elProjects.appendChild(row);
    }
  }

  function openEditor(projectId, {push=true}={}){
    currentProjectId = projectId;
    ovPidEl.textContent = projectId;
    statusEl.textContent = "";
    renderSlidesEditor();
    setDirty(false); // –æ—Ç–∫—Ä—ã–ª–∏ –∏–∑ –ë–î ‚Äî —Å—á–∏—Ç–∞–µ–º ¬´–±–µ–∑ –ø—Ä–∞–≤–æ–∫¬ª
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
    if(push){
      const p = new URLSearchParams(location.search);
      p.set("project_id", projectId);
      history.pushState({}, "", location.pathname + "?" + p.toString());
    }
  }

  function closeEditor({push=true}={}){
    if(!overlay.classList.contains("show")) return;
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
    currentProjectId = null;
    if(push){
      const p = new URLSearchParams(location.search);
      p.delete("project_id");
      history.pushState({}, "", location.pathname + (p.toString()?("?"+p.toString()):""));
    }
  }

  function renderSlidesEditor(){
    ovSlidesEl.innerHTML = "";
    const slides = (grouped.get(currentProjectId) || []).map(s => ({...s}));
    slides.sort(bySlide).forEach((s,i)=> s.slide = i+1);
    slides.forEach((s) => ovSlidesEl.appendChild(makeSlideRow(s)));
    ovSlidesEl.querySelectorAll(".slide").forEach(initDrag);
  }

 function makeSlideRow(slide){
  const row = document.createElement("div");
  row.className = "slide";
  // —É–±—Ä–∞–ª–∏ row.setAttribute("draggable", "true");

  row.dataset.templateId = slide.template_id ? String(slide.template_id) : "";

  const selectHtml = `<select class="templSel">
    <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω ‚Äî</option>
    ${templates.map(t => `
      <option value="${escapeAttr(String(t.id))}"${
        String(t.id) === String(slide.template_id) ? ' selected' : ''
      }>${escapeHtml(t.name || String(t.id))}</option>
    `).join("")}
  </select>`;

  row.innerHTML = `
    <div class="drag" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å" aria-label="drag">‚â°</div>
    <div>
      <div class="num">–°–ª–∞–π–¥</div>
      <div class="num"><span class="numVal">${slide.slide}</span></div>
      <div class="num" style="margin-top:8px">–¢–∏–ø</div>
      <input class="typeIn" value="${escapeAttr(slide.type ?? '')}" placeholder="type (cover, context, ...)" />
      <div class="num" style="margin-top:8px">–®–∞–±–ª–æ–Ω</div>
      ${selectHtml}
    </div>
    <div>
      <div class="num">–¢–µ–∫—Å—Ç</div>
      <textarea class="textIn" placeholder="—Ç–µ–∫—Å—Ç —Å–ª–∞–π–¥–∞...">${escapeHtml(slide.text ?? "")}</textarea>
    </div>
    <div>
      <div class="previewTitle"><span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span><span class="muted small"></span></div>
      <div class="previewCard"><div class="previewInner"></div></div>
    </div>
    <div class="delBtn">
      <button class="danger">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  `;

  // –¥–µ–ª–∞–µ–º draggable —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫—É
  const dragHandle = row.querySelector(".drag");
  dragHandle.setAttribute("draggable", "true");

  // –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî —Ç–≤–æ–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  row.querySelector(".danger").addEventListener("click", () => { row.remove(); renumberUI(); setDirty(true); });
  const templSel = row.querySelector(".templSel");
  templSel.addEventListener("change", () => {
    row.dataset.templateId = templSel.value || "";
    renderPreview(row);
    setDirty(true);
  });
  row.querySelector(".typeIn").addEventListener("input", () => setDirty(true));
  row.querySelector(".textIn").addEventListener("input", () => setDirty(true));

  renderPreview(row);
  return row;
}

  function renderPreview(row){
    const tplId = row.dataset.templateId || "";
    const holder = row.querySelector(".previewInner");
    holder.innerHTML = "";
    if(!tplId || !templatesById.has(tplId)){
      holder.innerHTML = `<div class="muted">–®–∞–±–ª–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω</div>`;
      return;
    }
    const tpl = templatesById.get(tplId);
    const mockMap = {
      "{{headline}}":"–ó–∞–≥–æ–ª–æ–≤–æ–∫",
      "{{text}}":"–ö–æ—Ä–æ—Ç–∫–∏–π –∞–±–∑–∞—Ü —Ç–µ–∫—Å—Ç–∞. –î–≤–∞-—Ç—Ä–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞.",
      "{{col1}}":"–ö–æ–ª–æ–Ω–∫–∞ 1 ‚Äî –º–æ–∫‚Äë—Ç–µ–∫—Å—Ç",
      "{{col2}}":"–ö–æ–ª–æ–Ω–∫–∞ 2 ‚Äî –º–æ–∫‚Äë—Ç–µ–∫—Å—Ç",
      "{{col3}}":"–ö–æ–ª–æ–Ω–∫–∞ 3 ‚Äî –º–æ–∫‚Äë—Ç–µ–∫—Å—Ç",
      "{{bullet1}}":"–ü—É–Ω–∫—Ç 1",
      "{{bullet2}}":"–ü—É–Ω–∫—Ç 2",
      "{{bullet3}}":"–ü—É–Ω–∫—Ç 3",
      "{{quote}}":"¬´–í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∞—è —Ü–∏—Ç–∞—Ç–∞¬ª",
      "{{author}}":"–ò–º—è –ê–≤—Ç–æ—Ä–∞"
    };
    let html = String(tpl.html_mock || "").trim();
    for(const [k,v] of Object.entries(mockMap)){
      html = html.split(k).join(v);
    }
    try{
      holder.innerHTML = html;
    }catch(_){
      holder.textContent = "–û—à–∏–±–∫–∞ –≤ html_mock";
    }
  }

  function initDrag(el){
    el.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", "");
      el.classList.add("dragging");
    });
    el.addEventListener("dragend", () => {
      el.classList.remove("dragging");
      renumberUI();
      setDirty(true);
    });
    ovSlidesEl.addEventListener("dragover", e => {
      e.preventDefault();
      const dragging = ovSlidesEl.querySelector(".dragging");
      const after = getDragAfterElement(ovSlidesEl, e.clientY);
      if (!after) ovSlidesEl.appendChild(dragging);
      else ovSlidesEl.insertBefore(dragging, after);
    });
  }

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll(".slide:not(.dragging)")];
    return els.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if (offset < 0 && offset > closest.offset) return { offset, element: child };
      return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function renumberUI(){
    [...ovSlidesEl.querySelectorAll(".slide")].forEach((row, i) => {
      row.querySelector(".numVal").textContent = i+1;
    });
  }

  function addSlideUI(){
    const row = makeSlideRow({ slide: (ovSlidesEl.children.length+1), type:"", text:"", template_id: "" });
    ovSlidesEl.appendChild(row);
    initDrag(row);
    renumberUI();
  }

  function buildSlidesPayload(){
    const rows = [...ovSlidesEl.querySelectorAll(".slide")];
    return rows.map((row, i) => {
      const type = row.querySelector(".typeIn").value.trim();
      const text = row.querySelector(".textIn").value;
      const template_id = row.dataset.templateId || null;
      return { slide: i+1, type, text, template_id };
    });
  }

  async function saveAll(){
    const slides = buildSlidesPayload();
    if(!currentProjectId){ return; }
    statusEl.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶";

    try{
      const res = await fetch(ENDPOINT_SAVE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          project_id: currentProjectId,
          replace: true,
          slides
        })
      });
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      await res.json().catch(()=> ({}));
      // –ª–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–º
      grouped.set(currentProjectId, slides.map(s => ({...s, project_id: currentProjectId})));
      renderProjects();
      setDirty(false);
      statusEl.textContent = "–ì–æ—Ç–æ–≤–æ ‚úî";
    }catch(e){
      statusEl.textContent = "–û—à–∏–±–∫–∞: " + e.message;
    }
  }

  async function publishProject(){
    if(!currentProjectId) return;
    // –∑–∞—â–∏—Ç–∞: –Ω–µ –ø—É–±–ª–∏–∫—É–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–∞–≤–∫–∏
    if(isDirty){
      statusEl.textContent = "–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë¬ª.";
      return;
    }
    publishBtn.disabled = true; publishBtn.textContent = "–ü—É–±–ª–∏–∫–∞—Ü–∏—è‚Ä¶";
    statusEl.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é‚Ä¶";

    try{
      const res = await fetch(ENDPOINT_PUBLISH, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ project_id: currentProjectId })
      });
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      await res.json().catch(()=> ({}));
      const url = "https://k-lesha.github.io/proposals/" + encodeURIComponent(currentProjectId) + ".html";
      statusEl.innerHTML = `–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ü—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω —á–µ—Ä–µ–∑ 1‚Äì2 –º–∏–Ω—É—Ç—ã –ø–æ —Å—Å—ã–ª–∫–µ: <a class="link" href="${url}" target="_blank" rel="noopener"> ${escapeHtml(url)} </a>`;
    }catch(e){
      statusEl.textContent = "–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: " + e.message;
    }finally{
      publishBtn.disabled = false; publishBtn.textContent = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
    }
  }

  // === utils / dirty management ===
  function setDirty(v=true){
    isDirty = !!v;
    updatePublishVisibility();
    if(isDirty){
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É, —á—Ç–æ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–∞–≤–∫–∏
      if(!statusEl.textContent) statusEl.textContent = "–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.";
    }
  }
  function updatePublishVisibility(){
    if(!publishBtn) return;
    publishBtn.style.display = isDirty ? "none" : "inline-block";
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }
  function escapeAttr(s){
    return String(s ?? "").replaceAll('"',"&quot;");
  }
</script>

  .// === NEW PROJECT ADD ===

  <script>
const ENDPOINT_CREATE_PROJECT = "https://kvlnk247-n8n.duckdns.org/webhook/0018ca67-56da-49ff-9257-b14bf0a68307";

// === –î–û–ë–ê–í–ò–¢–¨ –í –ë–õ–û–ö –ü–ï–†–ï–ú–ï–ù–ù–´–• ===
// File upload state
let selectedFiles = {
  commercial_offer: null,
  agency_files: [],
  client_files: []
};

// New project modal elements
const newProjectOverlay = document.getElementById("newProjectOverlay");
const newProjectBtn = document.getElementById("newProjectBtn");
const closeNewProjectBtn = document.getElementById("closeNewProjectBtn");
const newProjectForm = document.getElementById("newProjectForm");
const submitBtn = document.getElementById("submitBtn");
const formStatus = document.getElementById("formStatus");
const progress = document.getElementById("progress");
const progressFill = document.getElementById("progressFill");

// === –î–û–ë–ê–í–ò–¢–¨ –í –§–£–ù–ö–¶–ò–Æ init() –ü–û–°–õ–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í ===
// New project modal handlers
newProjectBtn.addEventListener("click", openNewProjectModal);
closeNewProjectBtn.addEventListener("click", closeNewProjectModal);
newProjectOverlay.addEventListener("click", e => { if (e.target === newProjectOverlay) closeNewProjectModal(); });
window.addEventListener("keydown", e => { if (e.key === "Escape" && newProjectOverlay.classList.contains("show")) closeNewProjectModal(); });

// Initialize form
initFileUploads();
initForm();

// === –î–û–ë–ê–í–ò–¢–¨ –≠–¢–ò –§–£–ù–ö–¶–ò–ò –í –ö–û–ù–ï–¶ SCRIPT ===
// === NEW PROJECT MODAL FUNCTIONS ===
function openNewProjectModal() {
  newProjectOverlay.classList.add("show");
  newProjectOverlay.setAttribute("aria-hidden", "false");
}

function closeNewProjectModal() {
  newProjectOverlay.classList.remove("show");
  newProjectOverlay.setAttribute("aria-hidden", "true");
  // Clear form
  newProjectForm.reset();
  selectedFiles = { commercial_offer: null, agency_files: [], client_files: [] };
  document.querySelectorAll('.file-list').forEach(list => list.innerHTML = '');
  formStatus.innerHTML = '';
}

// === FILE UPLOAD FUNCTIONS ===
function initFileUploads() {
  // Commercial offer (single file)
  initFileUpload('coUploadArea', 'commercialOffer', false, (files) => {
    selectedFiles.commercial_offer = files[0] || null;
    renderFileList('coFileList', files, 'commercial_offer');
  });

  // Agency files (multiple)
  initFileUpload('agencyUploadArea', 'agencyFiles', true, (files) => {
    selectedFiles.agency_files = Array.from(files);
    renderFileList('agencyFileList', selectedFiles.agency_files, 'agency_files');
  });

  // Client files (multiple)  
  initFileUpload('clientUploadArea', 'clientFiles', true, (files) => {
    selectedFiles.client_files = Array.from(files);
    renderFileList('clientFileList', selectedFiles.client_files, 'client_files');
  });
}

function initFileUpload(areaId, inputId, multiple, onFilesChange) {
  const area = document.getElementById(areaId);
  const input = document.getElementById(inputId);
  
  area.addEventListener('click', () => input.click());
  
  area.addEventListener('dragover', (e) => {
    e.preventDefault();
    area.classList.add('dragover');
  });
  
  area.addEventListener('dragleave', () => {
    area.classList.remove('dragover');
  });
  
  area.addEventListener('drop', (e) => {
    e.preventDefault();
    area.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files);
    if (!multiple && files.length > 1) {
      showFormMessage("–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª", "error");
      return;
    }
    
    // Set files to input
    const dt = new DataTransfer();
    files.forEach(file => dt.items.add(file));
    input.files = dt.files;
    
    onFilesChange(files);
  });
  
  input.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    onFilesChange(files);
  });
}

function renderFileList(containerId, files, type) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  if (!files || files.length === 0) return;
  
  (Array.isArray(files) ? files : [files]).forEach((file, index) => {
    if (!file) return;
    
    const item = document.createElement('div');
    item.className = 'file-item';
    item.innerHTML = `
      <div class="file-info">
        <span class="file-name">${escapeHtml(file.name)}</span>
        <span class="file-size">${formatFileSize(file.size)}</span>
      </div>
      <button type="button" class="file-remove" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª">‚úï</button>
    `;
    
    item.querySelector('.file-remove').addEventListener('click', () => {
      removeFile(type, index);
    });
    
    container.appendChild(item);
  });
}

function removeFile(type, index) {
  if (type === 'commercial_offer') {
    selectedFiles.commercial_offer = null;
    document.getElementById('commercialOffer').value = '';
    renderFileList('coFileList', [], type);
  } else if (type === 'agency_files') {
    selectedFiles.agency_files.splice(index, 1);
    updateInputFiles('agencyFiles', selectedFiles.agency_files);
    renderFileList('agencyFileList', selectedFiles.agency_files, type);
  } else if (type === 'client_files') {
    selectedFiles.client_files.splice(index, 1);
    updateInputFiles('clientFiles', selectedFiles.client_files);
    renderFileList('clientFileList', selectedFiles.client_files, type);
  }
}

function updateInputFiles(inputId, files) {
  const input = document.getElementById(inputId);
  const dt = new DataTransfer();
  files.forEach(file => dt.items.add(file));
  input.files = dt.files;
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// === FORM SUBMISSION ===
function initForm() {
  newProjectForm.addEventListener('submit', handleFormSubmit);
}

async function handleFormSubmit(e) {
  e.preventDefault();
  
  const formData = new FormData();
  
  // Text fields
  formData.append('–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞', document.getElementById('clientName').value.trim());
  formData.append('–¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–≤–≤–æ–¥–Ω–∞—è / –±—Ä–∏—Ñ)', document.getElementById('currentContext').value.trim());
  formData.append('–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –∑–∞–¥–∞—á ', document.getElementById('taskDecomposition').value.trim());
  
  // Files
  if (selectedFiles.commercial_offer) {
    formData.append('commercial_offer_all_sheets_pdf', selectedFiles.commercial_offer);
  }
  
  selectedFiles.agency_files.forEach(file => {
    formData.append('agency_files', file);
  });
  
  selectedFiles.client_files.forEach(file => {
    formData.append('client_files', file);
  });

  // Submit
  try {
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...';
    showProgress(true);
    showFormMessage("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É...", "info");

    const response = await fetch(ENDPOINT_CREATE_PROJECT, {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const result = await response.text();
    
    showFormMessage("‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è! –ó–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.", "success");
    
    // Refresh projects list after some delay
    setTimeout(() => {
      fetchAllSlides().then(() => renderProjects());
    }, 3000);

  } catch (error) {
    console.error('Form submission error:', error);
    showFormMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, "error");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'üöÄ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç';
    showProgress(false);
  }
}

function showProgress(show) {
  progress.style.display = show ? 'block' : 'none';
  if (show) {
    let width = 0;
    const interval = setInterval(() => {
      width += Math.random() * 10;
      if (width >= 90) {
        clearInterval(interval);
        width = 90;
      }
      progressFill.style.width = Math.min(width, 100) + '%';
    }, 200);
  } else {
    progressFill.style.width = '0%';
  }
}

function showFormMessage(message, type) {
  formStatus.innerHTML = `<div class="status-message status-${type}">${escapeHtml(message)}</div>`;
  setTimeout(() => {
    if (formStatus.textContent === message) {
      formStatus.innerHTML = '';
    }
  }, type === 'success' ? 8000 : 5000);
}
</script>
</body>
</html>
